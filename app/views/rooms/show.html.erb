<%= render "shared/header" %>

<div class="page-wrapper">
  <div class="pagetitle">
  対戦ルーム
  </div>

  <div class="room_contents">
    
    <%# ルール %>
    <div class="rule">
      <%# ルールが保存されていれば表示 %>
      <% if @room.rule_selected? %>
        <h3>ルール</h3>
        <div>部屋ID：<%= @room.rule.room_code %></div>
        <div>PASS：<%= @room.rule.room_pass %></div>
        <div><%= Format.find(@room.rule.format_id).name %></div>
        <div><%= MatchCount.find(@room.rule.match_count_id).name %></div>
        
        <%# 通話の可否で表示変更 %>
        <% if @room.rule.voice_chat_id == 2 %>
          <div>通話可</div>
          <div>Discordフレンドコード: <%= @room.rule.discord %></div>
        <% else %>
          <div>通話不可</div>
        <% end %>
        <%= link_to "ルール変更", edit_room_rule_path(@room), id:"edit-rule-btn", class:'btn btn-primary' %>

        <%# ルール画像表示 %>
        <% if @room.rule.format_id == 2 %>
          <%= image_tag "Smash_Ball.svg.png", alt: "Image 1", class:"rule-img" %>
        <% elsif @room.rule.format_id == 3 %>
          <%= image_tag "Smash_Ball.svg.png", alt: "Image 2", class:"rule-img" %>
        <% end %>

      <%# ルール未選択なら表示 %>
      <% else %>
        <h3>ルールを選択してください</h3>
        <div class="rule-form">
          <%= form_with model: [@room, @rule], url: room_rules_path(@room), class: 'form', id: 'rule-form', local: true do |f| %>
            <div class="form-group">
              <%= f.label :room_code, "部屋ID" %>
              <%= f.text_field :room_code, class: 'form-control' %>
            </div>
            <div class="form-group">
              <%= f.label :room_pass, "部屋PASS" %>
              <%= f.text_field :room_pass, class: 'form-control' %>
            </div>            
            <div class="form-group">
              <%= f.label :format, "形式" %>
              <%= f.collection_select(:format_id, Format.all, :id, :name, {}, {class:"rule-select"}) %>
            </div>
            <div class="form-group">
              <%= f.label :match_count, "試合数" %>
              <%= f.collection_select(:match_count_id, MatchCount.all, :id, :name, {}, {class:"rule-select"}) %>
            </div>
            <div class="form-group">
              <%= f.label :voice_chat, "通話の可否" %>
              <%= f.collection_select(:voice_chat_id, VoiceChat.all, :id, :name, {}, {class:"rule-select"}) %>
            </div>
            <div class="form-group" id="discord-input-group" style="display: none;">
              <%= f.label :discord, "discordフレンドコード" %>
              <%= f.text_field :discorde, class: 'form-control' %>
            </div>
            <%= f.submit 'ルールを保存', class:'btn btn-primary' %>
          <% end %>
        </div>
      <% end %>
    </div>
    <%# ルールここまで %>

    <div class="match-up">
      <div>
        ユーザー１
      </div>
      <div>
        ユーザー２
      </div>
    </div>
    <div class="chat-box">
      <div class="messages-area">
        <% @messages.each do |message|%>
          <div class="message">
            <div class="massage-user">
              <%= User.find(message.user_id).nickname%>
            </div>
            <div class="message-content">
              <%= message.content%>
              </div>
          </div>
        <% end %>
      </div>
      <%= form_with model: [@room, @message], url: room_messages_path(@room), class: 'form', local: true do |f| %>
        <div class="form-input">
          <%= f.text_field :content, class: 'form-message', placeholder: 'type a message' %>
        </div>
        <%= f.submit '送信', class: 'form-submit' %>
      <% end %>
    </div>
  </div>
</div>

<div id="form_popup" class="popup">
  <div class="overlay"></div>
  <div class="rule-form">
    ルール編集
    <%= form_with model: [@room, @rule], url: room_rule_path(@room), class: 'form', id: 'rule-form', local: true do |f| %>
      <div class="form-group">
        <%= f.label :room_code, "部屋ID" %>
        <%= f.text_field :room_code, class: 'form-control', id:"rule_room_code" %>
      </div>
      <div class="form-group">
        <%= f.label :room_pass, "部屋PASS" %>
        <%= f.text_field :room_pass, class: 'form-control', id:"rule_room_pass" %>
      </div>            
      <div class="form-group">
        <%= f.label :format, "形式" %>
        <%= f.collection_select(:format_id, Format.all, :id, :name, {}, {class:"rule-select", id:"rule_format_id"}) %>
      </div>
      <div class="form-group">
        <%= f.label :match_count, "試合数" %>
        <%= f.collection_select(:match_count_id, MatchCount.all, :id, :name, {}, {class:"rule-select", id:"rule_match_count_id"}) %>
      </div>
      <div class="form-group">
        <%= f.label :voice_chat, "通話の可否" %>
        <%= f.collection_select(:voice_chat_id, VoiceChat.all, :id, :name, {}, {class:"rule-select", id:"rule_voice_chat_id"}) %>
      </div>
      <div class="form-group" id="discord-input-group" style="display: none;">
        <%= f.label :discord, "discordフレンドコード" %>
        <%= f.text_field :discorde, class: 'form-control', id:"rule_discord" %>
      </div>
      <%= f.submit 'ルールを保存', class:'btn btn-primary' %>
    <% end %>
  </div>
</div>